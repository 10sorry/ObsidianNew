**3.3.X. Программный модуль «Редактор журнала»**

Модуль «Редактор журнала» предназначен для визуального редактирования содержимого таблицы журнала, отображения и фильтрации записей, а также печати и управления структурой таблицы.
### 1) Класс `JournalEditWindow`

Класс `JournalEditWindow` — предоставляет диалоговое окно для редактирования таблицы журнала PostgreSQL. Поддерживает визуальный интерфейс, взаимодействие с базой данных, поиск, печать и фильтрацию записей.

```
#include "JournalEditWindow.h"
```

**Базовый класс:** `QDialog`

---
#### Основные функции класса:

1. `**JournalEditWindow(QWidget* parent = nullptr)**` — конструктор. Инициализирует UI, связывает таблицу с моделью, выполняет настройку фильтров, анимации, индикаторов и подключений.
    
2. `**~JournalEditWindow()**` — деструктор, освобождает ресурсы.
    
3. `**void setupConnectors()**` — устанавливает сигнально-слотовые связи между элементами управления UI и действиями на таблице, включая реакции на изменения данных.
    
4. `**void createTable()**` — связывает таблицу с моделью данных `QSqlTableModel`, настраивает отображение и скрывает системные колонки.
    
5. `**void hideColumns(const QList<int>& columnIndexes)**` — скрывает определённые столбцы в `QTableView`.
    
6. `**void setupIndicators()**` — инициализирует индикаторы состояния, отображаемые в нижней части окна.
    
7. `**void changeIndicatorColor(QLabel *label, char status)**` — задаёт цвет и стиль метки-индикатора в зависимости от статуса.
    
8. `**QString getIndicatorsText(AVSKU_UNITS *av)**` — возвращает строковое представление типа устройства AVSKU. (_в стадии разработки_)
    
9. `**void getColumn(int index)**` — выбирает столбец по горизонтальному заголовку, запоминает имя и индекс.
    
10. `**void getRow(int index)**` — выбирает строку по вертикальному заголовку, запоминает имя и индекс.
    
11. `**QString showTextDialog()**` — вызывает диалог для ввода имени новой колонки, возвращает результат.
    
12. `**void on_findButton_clicked()**` — реализует поиск по таблице по значению, выделяет все совпадения.
    
13. `**void on_renameButton_clicked()**` — выполняет переименование колонки по индексу, выбранному пользователем.
    
14. `**void on_recreateButton_clicked()**` — закрывает БД, запускает внешний скрипт `recreate.sh`, повторно открывает БД и обновляет модель.
    
15. `**void on_table_view_clicked(const QModelIndex& index)**` — сохраняет выбранный индекс ячейки.
    
16. `**void on_openMessageBtn_clicked()**` — открывает диалог `CellDialog` с содержимым выбранной ячейки.
    
17. `**void on_clearButton_clicked()**` — очищает все колонки из модели, затем обновляет её содержимое.
    
18. `**void on_i_rangeButton_clicked()**` — анимирует появление/скрытие панели фильтра.
    
19. `**void on_toolButtonPrint_clicked()**` — реализует печать содержимого таблицы на принтер с разбивкой по страницам.
    
20. `**void updateDialogPos()**` — размещает всплывающий диалог относительно правого верхнего угла окна.
    
21. `**void applyFilters()**` — применяет фильтры по имени и времени к таблице через `PostgresConnector`.
    

---

#### Вспомогательные объекты:

- `PostgresConnector postgcon` — интерфейс взаимодействия с PostgreSQL.
    
- `QSqlTableModel* model` — модель данных таблицы.
    
- `QSqlDatabase db` — объект базы данных.
    
- `QLineEdit* idxFilterEdit`, `QTimeEdit* ctimeFilterEdit` — виджеты фильтрации.
    
- `QPropertyAnimation* animation` — объект анимации панели фильтра.
    
- `QList<QTableView*> tableList` — список таблиц в интерфейсе.
    
- `QList<QToolButton*> buttons` — все кнопки на форме.
    
- `QLabel* indicators[NUM_AVSKU_UNITS]` — массив меток-индикаторов.

### 2) Класс `TextDialog`

Модуль предназначен для отображения диалогового окна, позволяющего пользователю ввести имя новой строки/столбца и выбрать тип добавляемого элемента (строка или столбец). Используется в составе `JournalEditWindow` при изменении структуры таблицы журнала.

**Класс:** `TextDialog`  
**Базовый класс:** `QDialog`

```
#include "TextDialog.h"
```

---
#### Назначение:

Класс `TextDialog` предоставляет диалоговое окно с полем ввода текста (`QLineEdit`) и двумя флагами (`QCheckBox`) для выбора типа добавляемого элемента: колонка или строка. По нажатию кнопки "OK" сохраняет результат и закрывает окно.

---
#### Основные функции класса:

1. `**TextDialog(QWidget* parent = nullptr)**`  
    Конструктор. Выполняет инициализацию интерфейса, подключает сигналы и задаёт заголовок окна.
    
2. `**~TextDialog()**`  
    Деструктор. Освобождает память от UI.
    
3. `**void writeResult(bool result)**`  
    Устанавливает внутренний флаг `isColumn` в зависимости от выбранного пользователем флага (колонка или строка). Используется при переключении `QCheckBox`.
    
4. `**bool getResult() const**`  
    Возвращает флаг `isColumn`, определяющий тип добавляемого элемента: `true` — колонка, `false` — строка.
    
5. `**QString getColumnName() const**`  
    Возвращает текст, введённый пользователем в поле `QLineEdit`, используемый как имя новой колонки (или строки).


---
#### Компоненты UI:

- `QLineEdit* lineEdit` — поле ввода имени нового столбца/строки.
    
- `QCheckBox* checkboxColumn` — чекбокс "Добавить колонку".
    
- `QCheckBox* checkboxRow` — чекбокс "Добавить строку".
    
- `QPushButton* okButton` — кнопка подтверждения ввода.

### 3) Класс `CellDialog`

Модуль предназначен для отображения содержимого всей строки таблицы журнала в отдельном окне. Используется для детального просмотра информации, связанной с выбранной записью.

**Класс:** `CellDialog`  
**Базовый класс:** `QDialog`

```
#include "CellDialog.h"
```

---
#### Назначение:

Класс `CellDialog` отображает данные из одной строки таблицы журнала в виде вертикального списка с заголовками колонок. Также отображается дополнительная информация в отдельной таблице.

Диалог вызывается из `JournalEditWindow` по клику на кнопку «Просмотр сообщения».

---
#### Основные функции класса:

1. `**CellDialog(QWidget* parent, QSqlTableModel* model, QModelIndex index)**`  
    Конструктор. Отображает значения всех ячеек строки `index.row()` модели `model` в `QTableWidget`. Также выводит список дополнительных данных (пока захардкожен).
    
2. `**~CellDialog()**`  
    Деструктор. Освобождает память от интерфейса.
    
3. `**void renameHeader(QTableWidget* widget, QString text)**`  
    Переименовывает горизонтальный заголовок таблицы `widget`, устанавливая в нём `text`.
    
4. `**void addInformation(QList<QString> items)**`  
    Заполняет таблицу `tableWidget2` значениями из `items`. Используется для отображения дополнительной информации.
    

---
#### Компоненты UI:

- `QTableWidget* tableWidget` — основная таблица, отображающая содержимое одной строки таблицы журнала.
    
- `QTableWidget* tableWidget2` — таблица для отображения дополнительной информации (захардкоженный список строк).
    
- `QHeaderView* horizontalHeader` — используется для растягивания колонок до ширины таблицы.

### 4) Класс `FilterDialog`

**Модуль предназначен для задания фильтрации данных в таблице журнала.**  
Позволяет пользователю выбрать диапазон значений по времени (`ctime`) или по индексам (`idx`) с помощью двойного слайдера и применить фильтр к данным.

---

### Класс: `FilterDialog`

**Базовый класс:** `QDialog`  
**Заголовочный файл:** `#include "FilterDialog.h"`

---

### 📌 Назначение:

Класс `FilterDialog` реализует пользовательский интерфейс для задания фильтров по диапазонам.  
Пользователь может выбрать один из двух типов фильтрации:

- По времени создания (от 0 до 23 часов)
    
- По индексам записей (диапазон берётся из модели)
    

Выбранный диапазон передаётся в основной виджет через сигнал.

---

### 🔧 Основные функции класса:

#### `FilterDialog(QWidget* parent, std::unordered_map<std::string, std::pair<int, int>> min_maxValues)`

Конструктор. Инициализирует интерфейс диалога, встраивает слайдер `DoubleRangeSlider`, настраивает начальные значения слайдера из переданного словаря диапазонов (`ctime`, `idx`), подключает сигналы и устанавливает поведение радиокнопок.

#### `~FilterDialog()`

Деструктор. Освобождает память, удаляет `ui`, `rangeSlider` и `QButtonGroup`.

#### `int getMinVTransfer() const`, `int getMaxVTransfer() const`

Возвращают значения, выбранные пользователем на `DoubleRangeSlider`. Эти значения могут быть использованы внешним кодом для уточнённой фильтрации.

#### `void on_time_radioButton_toggled(bool checked)`

Обработчик переключения радиокнопки "Фильтр по времени". Устанавливает диапазон слайдера на [0, 23].

#### `void on_index_radioButton_toggled(bool checked)`

Обработчик переключения радиокнопки "Фильтр по индексу". Устанавливает диапазон на [minIndex, maxIndex], полученные из входной мапы.

#### `void on_submitButton_clicked()`

При подтверждении пользователем:

- Сохраняет текущие значения слайдера как `minVTransfer` и `maxVTransfer`.
    
- Отправляет сигнал `sortTableSignal(QString)` с выбранным типом фильтрации (`ctime` или `idx`).
    
- Закрывает диалог.
    

#### `void min_maxValues()`

Сбрасывает поля отображения минимального и максимального значения (в `QLabel`) до пустого состояния. Может быть использовано для очистки состояния перед новым вызовом окна.

---

### 🧩 Компоненты UI:

|Компонент|Назначение|
|---|---|
|`DoubleRangeSlider* rangeSlider`|Кастомный слайдер с двумя ручками для выбора диапазона|
|`QRadioButton* time_radioButton`, `index_radioButton`|Выбор режима фильтрации|
|`QLabel* minValueLabel`, `maxValueLabel`|Отображают текущие значения диапазона|
|`QPushButton* submitButton`|Подтверждение выбора|
|`QButtonGroup* b_group`|Объединяет радиокнопки|
### 5) Класс `DoubleRangeSlider`

Модуль предназначен для выбора диапазона значений при помощи двух ползунков на одном слайдере. Используется в фильтрации значений по диапазону в пользовательском интерфейсе (например, при сортировке данных по значениям от-до).

**Класс:** `DoubleRangeSlider`  
**Базовый класс:** `QSlider`

```
#include "DoubleRangeSlider.h"
```

---

#### Назначение:

Класс `DoubleRangeSlider` расширяет стандартный `QSlider`, предоставляя возможность устанавливать и визуализировать два значения — нижнюю и верхнюю границы выбранного диапазона. Пользователь может перемещать каждый из ползунков независимо с помощью мыши.

Используется в фильтрационных диалогах, например, `FilterDialog`, для задания диапазона значений.

---

#### Основные функции класса:

- __DoubleRangeSlider(Qt::Orientation orientation, QWidget__ _parent)_*  
    Конструктор. Устанавливает ориентацию слайдера (горизонтальная или вертикальная). Подключается к UI как обычный виджет.
    
- **void setLowerValue(int value)**  
    Устанавливает значение левого (нижнего) ползунка, ограничивая его снизу `m_minRange` и сверху значением `m_upperValue`.
    
- **void setUpperValue(int value)**  
    Устанавливает значение правого (верхнего) ползунка, ограничивая его снизу значением `m_lowerValue` и сверху `m_maxRange`.
    
- **void setRange(int lower, int upper)**  
    Устанавливает диапазон значений для всего слайдера (`m_minRange`, `m_maxRange`).
    

---

#### Переопределённые события:

- *_void mousePressEvent(QMouseEvent_ __event)__  
    Определяет, какой из ползунков (левый или правый) будет перетаскиваться в зависимости от близости к курсору.
    
- *_void mouseMoveEvent(QMouseEvent_ __event)__  
    Обрабатывает движение мыши и обновляет позицию выбранного ползунка в соответствии с положением мыши.
    
- *_void paintEvent(QPaintEvent_ __event)__  
    Отвечает за отрисовку слайдера: рисуются две ручки, трек и метки, соответствующие значениям `m_lowerValue` и `m_upperValue`.
    

---

#### Сигналы:

- **void lowerValueChanged(int value)**  
    Сигнал, испускаемый при изменении значения нижнего ползунка.
    
- **void upperValueChanged(int value)**  
    Сигнал, испускаемый при изменении значения верхнего ползунка.
    

---

#### Основные переменные:

- **int m_lowerValue** — Текущее значение нижней границы.
    
- **int m_upperValue** — Текущее значение верхней границы.
    
- **int m_minRange, m_maxRange** — Минимум и максимум для диапазона слайдера.
    
- **bool m_isLowerHandleSelected** — Флаг, определяющий, какой ползунок перетаскивается в текущий момент.