
# –ò–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏

–î–∞—Ç–∞: [[2025-07-23]]
–¢–µ–≥–∏: #cpp
–°–≤—è–∑–∏: [[c++]] 

---
**–û–ø–∏—Å–∞–Ω–∏–µ**:
### ‚ùå **1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–º–∞–Ω—Ç–∏–∫–µ —É–∫–∞–∑–∞—Ç–µ–ª—è**

- –û–±—ä—è–≤–ª–µ–Ω–∏–µ `T* ptr` –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç:
    
    - –£–∫–∞–∑—ã–≤–∞–µ—Ç –ª–∏ –æ–Ω –Ω–∞ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –∏–ª–∏ –Ω–∞ –º–∞—Å—Å–∏–≤.
        
    - –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –æ–±—ä–µ–∫—Ç–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–º.
        

### ‚ùå **2. –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –∫—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ**

- –ò–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–ª—å–∑—è –ø–æ–Ω—è—Ç—å:
    
    - –ö—Ç–æ –¥–æ–ª–∂–µ–Ω —É–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç.
        
    - –ö–æ–≥–¥–∞ –∏ –∫–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω–æ.
        

### ‚ùå **3. –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω —Å–ø–æ—Å–æ–± —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è**

- –î–∞–∂–µ –µ—Å–ª–∏ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –æ–±—ä–µ–∫—Ç –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, **–Ω–µ—è—Å–Ω–æ —á–µ–º**:
    
    - `delete`?
        
    - `delete[]`?
        
    - –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `destroy(ptr)`?
        

### ‚ùå **4. –õ–µ–≥–∫–æ –æ—à–∏–±–∏—Ç—å—Å—è —Å `delete` vs `delete[]`**

- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–µ–¥—ë—Ç –∫ **–Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é**.
    

### ‚ùå **5. –¢—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ–º**

- –û–±–µ—Å–ø–µ—á–∏—Ç—å **—Ç–æ—á–Ω–æ –æ–¥–Ω–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ** –æ–±—ä–µ–∫—Ç–∞:
    
    - –°–ª–æ–∂–Ω–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ **–∏—Å–∫–ª—é—á–µ–Ω–∏–π**, **–≤–µ—Ç–≤–ª–µ–Ω–∏–π**, **–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞**.
        
    - –û–¥–∏–Ω –ª–∏—à–Ω–∏–π `delete` ‚Üí UB, –æ–¥–∏–Ω –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π ‚Üí —É—Ç–µ—á–∫–∞.
        

### ‚ùå **6. –û–ø–∞—Å–Ω–æ—Å—Ç—å –≤–∏—Å—è—á–∏—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π**

- –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ —É–∫–∞–∑–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç **–ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω–Ω—É—é –ø–∞–º—è—Ç—å**.
    
- –≠—Ç–æ –≤–µ–¥—ë—Ç –∫ –æ—à–∏–±–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä—É–¥–Ω–æ –æ—Ç–ª–æ–≤–∏—Ç—å –∏ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å.

–í `C++11` –∏–º–µ—é—Ç—Å—è *4* —Ç–∏–ø–∞ –∏–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π:
- `unique_ptr`
- `shared_ptr`
- `auto_ptr`(—É—Å—Ç–∞—Ä–µ–ª)
- `weak_ptr`

#### `unique_ptr` 

##### –ß—Ç–æ —ç—Ç–æ?

- **–£–º–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å**, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π **—É–Ω–∏–∫–∞–ª—å–Ω—ã–º –≤–ª–∞–¥–µ–Ω–∏–µ–º** —Ä–µ—Å—É—Ä—Å–∞ (–æ–±—ã—á–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞).
    
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `delete` –∏–ª–∏ `delete[]` –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏.
    
- –ù–µ–ª—å–∑—è –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ **–ø–µ—Ä–µ–º–µ—â–∞—Ç—å**!
    
---
#### –ö–ª—é—á–µ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞

|–°–≤–æ–π—Å—Ç–≤–æ|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|–í–ª–∞–¥–µ–Ω–∏–µ|–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω `unique_ptr` –≤–ª–∞–¥–µ–µ—Ç –æ–±—ä–µ–∫—Ç–æ–º|
|–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ|**–ó–∞–ø—Ä–µ—â–µ–Ω–æ** (`copy ctor` –∏ `copy assign` —É–¥–∞–ª–µ–Ω—ã)|
|–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ|**–†–∞–∑—Ä–µ—à–µ–Ω–æ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** (`move ctor` –∏ `move assign`)|
|–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ|–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ `delete` –∏–ª–∏ `delete[]` –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏|
|–ú–∞—Å—Å–∏–≤—ã|–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `unique_ptr<T[]>`|
#### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã

```cpp
std::unique_ptr<T> ptr1 = std::make_unique<T>(args); // —Å–æ–∑–¥–∞–Ω–∏–µ

std::unique_ptr<T> ptr2 = std::move(ptr1);           // –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–Ω–∏—è

// std::unique_ptr<T> ptr3 = ptr2;                    // ‚ùå –æ—à–∏–±–∫–∞: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ
```

---
#### –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å?

- –ï—Å–ª–∏ –±—ã –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑—Ä–µ—à–∞–ª–æ—Å—å, –¥–≤–∞ `unique_ptr` —É–∫–∞–∑—ã–≤–∞–ª–∏ –±—ã –Ω–∞ –æ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å ‚Üí –¥–≤–æ–π–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ ‚Üí UB.
    
---
#### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏?

```
unique_ptr(unique_ptr&& other) noexcept {
    ptr = other.ptr;
    other.ptr = nullptr; // "–æ–±–Ω—É–ª—è–µ–º" –∏—Å—Ö–æ–¥–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å
}
```

- **–ü–µ—Ä–µ–¥–∞—ë–º –≤–ª–∞–¥–µ–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–∞.
    
- –°—Ç–∞—Ä—ã–π `unique_ptr` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—É—Å—Ç—ã–º (`nullptr`).
    
- –ù–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–Ω–æ—Å "—Å—ã—Ä—ã—Ö" —É–∫–∞–∑–∞—Ç–µ–ª–µ–π.
    
---
#### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å –º–∞—Å—Å–∏–≤–∞–º–∏

- –î–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `unique_ptr<T[]>`:
    
    - –í—ã–∑—ã–≤–∞–µ—Ç `delete[]` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        
    - –ú–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä `[]`:
        
```
std::unique_ptr<int[]> arr = std::make_unique<int[]>(10);
arr[0] = 42;
```
---
#### –í–∞–∂–Ω—ã–µ –º–µ—Ç–æ–¥—ã

|                |                                                |
| -------------- | ---------------------------------------------- |
| –ú–µ—Ç–æ–¥          | –û–ø–∏—Å–∞–Ω–∏–µ                                       |
| `release()`    | –û—Ç–¥–∞—ë—Ç —Å—ã—Ä–æ–π —É–∫–∞–∑–∞—Ç–µ–ª—å, –æ–±–Ω—É–ª—è—è –≤–ª–∞–¥–µ–Ω–∏–µ       |
| `reset()`      | –£–¥–∞–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç nullptr  |
| `get()`        | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä–æ–π —É–∫–∞–∑–∞—Ç–µ–ª—å –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –≤–ª–∞–¥–µ–Ω–∏—è |
| `operator*()`  | –î–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç—É                               |
| `operator->()` | –î–æ—Å—Ç—É–ø –∫ —á–ª–µ–Ω–∞–º –æ–±—ä–µ–∫—Ç–∞                        |

---
#### –ü—Ä–∏–º–µ—Ä –±–∞–∑–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```cpp
#include <memory>

struct Foo { int x; };

int main() {
    auto p = std::make_unique<Foo>(); // —Å–æ–∑–¥–∞—ë–º
    p->x = 42;

    std::unique_ptr<Foo> p2 = std::move(p); // –ø–µ—Ä–µ–Ω–æ—Å –≤–ª–∞–¥–µ–Ω–∏—è
    // p —Ç–µ–ø–µ—Ä—å –ø—É—Å—Ç–æ–π (nullptr)

    if (!p) {
        // ...
    }
}
```

---
#### `shared_ptr`

#### –ß—Ç–æ —ç—Ç–æ?

- –£–º–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å –¥–ª—è **—Ä–∞–∑–¥–µ–ª—è–µ–º–æ–≥–æ –≤–ª–∞–¥–µ–Ω–∏—è** —Ä–µ—Å—É—Ä—Å–∞.
    
- –ù–µ—Å–∫–æ–ª—å–∫–æ `shared_ptr` –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç.
    
- –û–±—ä–µ–∫—Ç —É–¥–∞–ª—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π `shared_ptr` –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –≤–ª–∞–¥–µ—Ç—å (—Å—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –Ω—É–ª—è).
    
---
#### –ö–ª—é—á–µ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞

|–°–≤–æ–π—Å—Ç–≤–æ|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|–í–ª–∞–¥–µ–Ω–∏–µ|–†–∞–∑–¥–µ–ª—è–µ–º–æ–µ, –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤|
|–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ|–†–∞–∑—Ä–µ—à–µ–Ω–æ, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫|
|–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ|–†–∞–∑—Ä–µ—à–µ–Ω–æ|
|–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ|–û–±—ä–µ–∫—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞|
|–°—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫|–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π, —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞|

---
#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?

- –ü—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ `shared_ptr` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—á—ë—Ç—á–∏–∫.
    
- –ü—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ —Å—á—ë—Ç—á–∏–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è.
    
- –ö–æ–≥–¥–∞ —Å—á—ë—Ç—á–∏–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 0 ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `delete` –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–º –æ–±—ä–µ–∫—Ç–µ.
    
---
### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Ä–∏—Å–∫–∏

- **–í–æ–∑–º–æ–∂–Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞**, –ø—Ä–∏–≤–æ–¥—è—â–∞—è –∫ —É—Ç–µ—á–∫–µ –ø–∞–º—è—Ç–∏.
    
- –ë–æ–ª–µ–µ —Ç—è–∂—ë–ª—ã–π –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `unique_ptr` –∏–∑-–∑–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—á—ë—Ç—á–∏–∫–∞.
    
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–∫–∞—Å—Ç–æ–º–Ω—ã–µ –¥–µ–ª–∏—Ç–µ—Ä—ã**.
---
### –ü—Ä–∏–º–µ—Ä

```cpp
#include <memory>

struct Foo { int x; };

int main() {
    std::shared_ptr<Foo> p1 = std::make_shared<Foo>();
    std::shared_ptr<Foo> p2 = p1; // –ö–æ–ø–∏—Ä—É–µ–º, —Ç–µ–ø–µ—Ä—å –¥–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞

    p1->x = 10;
    // –û–±—ä–µ–∫—Ç —É–¥–∞–ª–∏—Ç—Å—è, –∫–æ–≥–¥–∞ p1 –∏ p2 –±—É–¥—É—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã
}
```

---
#### `weak_ptr`

#### –ß—Ç–æ —ç—Ç–æ?

- –°–ª–∞–±—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å, –Ω–µ –≤–ª–∞–¥–µ–µ—Ç –æ–±—ä–µ–∫—Ç–æ–º.
    
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è** –∑–∞ –æ–±—ä–µ–∫—Ç–æ–º, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–º `shared_ptr`.
    
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å **—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫**.
    
---
#### –ö–ª—é—á–µ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞

|                   |                                                                                     |
| ----------------- | ----------------------------------------------------------------------------------- |
| –°–≤–æ–π—Å—Ç–≤–æ          | –û–ø–∏—Å–∞–Ω–∏–µ                                                                            |
| –í–ª–∞–¥–µ–Ω–∏–µ          | **–ù–µ –≤–ª–∞–¥–µ–µ—Ç** –æ–±—ä–µ–∫—Ç–æ–º                                                             |
| –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ       | –†–∞–∑—Ä–µ—à–µ–Ω–æ                                                                           |
| –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ       | –†–∞–∑—Ä–µ—à–µ–Ω–æ                                                                           |
| –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ | –ß–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `.lock()`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `shared_ptr` –∏–ª–∏ `nullptr`, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω |

---
#### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

```cpp
std::shared_ptr<Foo> sp = std::make_shared<Foo>();
std::weak_ptr<Foo> wp = sp; // –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å

if (auto p = wp.lock()) {
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º p ‚Äî –æ–±—ä–µ–∫—Ç –µ—â—ë –∂–∏–≤
} else {
    // –û–±—ä–µ–∫—Ç —É–∂–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω
}
```

---
### –ó–∞—á–µ–º?

- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç **—É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –∏–∑-–∑–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫** –≤ —Å–ª–æ–∂–Ω—ã—Ö –≥—Ä–∞—Ñ–∞—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∂–∏–≤ –ª–∏ –æ–±—ä–µ–∫—Ç –±–µ–∑ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –µ–≥–æ –∂–∏–∑–Ω–∏.
- –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å `std::weak_ptr` ‚Äî **—Ä–∞–∑–æ—Ä–≤–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`shared_ptr` ‚Üî `shared_ptr`)**, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç **—É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏** –¥–∞–∂–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `shared_ptr`.

---

### üí£ –ß—Ç–æ –∑–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏?


–ü—Ä–µ–¥—Å—Ç–∞–≤—å –¥–≤–∞ –æ–±—ä–µ–∫—Ç–∞ A –∏ B, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç `std::shared_ptr` –Ω–∞ –¥—Ä—É–≥–æ–π:

```cpp
struct B; // forward

struct A {
    std::shared_ptr<B> b_ptr;
};

struct B {
    std::shared_ptr<A> a_ptr;
};
```

—Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –∏—Ö —Ç–∞–∫:

```cpp
std::shared_ptr<A> a = std::make_shared<A>();
std::shared_ptr<B> b = std::make_shared<B>();
a->b_ptr{b};
b->a_ptr{a};
```

–£ –∫–∞–∂–¥–æ–≥–æ `shared_ptr` —Å—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ `use_count == 1`, –Ω–æ –æ–±–∞ —Å—Å—ã–ª–∞—é—Ç—Å—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞.  
–ö–æ–≥–¥–∞ `a` –∏ `b` –≤—ã—Ö–æ–¥—è—Ç –∏–∑ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ ‚Äî –æ–Ω–∏ **–Ω–µ —É–Ω–∏—á—Ç–æ–∂–∞—Ç—Å—è**, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Å—ã–ª–∫–∏ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ **–Ω–µ –¥–∞—é—Ç —Å—á—ë—Ç—á–∏–∫—É —Å—Ç–∞—Ç—å 0**. –≠—Ç–æ –∏ –µ—Å—Ç—å **—É—Ç–µ—á–∫–∞**.


```cpp
struct B; // forward

struct A {
    std::shared_ptr<B> b_ptr;
};

struct B {
    std::weak_ptr<A> a_ptr; // üí° —Ç–µ–ø–µ—Ä—å weak_ptr!
};
```

—Ç–µ–ø–µ—Ä—å –≤—Å—ë –æ–∫:

- `a` –≤–ª–∞–¥–µ–µ—Ç `b`, `a->b_ptr` ‚Äî —ç—Ç–æ `shared_ptr`.
    
- `b` –ù–ï –≤–ª–∞–¥–µ–µ—Ç `a`, `b->a_ptr` ‚Äî —ç—Ç–æ `weak_ptr`.
    
–ò –∫–æ–≥–¥–∞ `a` –∏ `b` –≤—ã—Ö–æ–¥—è—Ç –∏–∑ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏, **–≤—Å—ë —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ**, –±–µ–∑ —É—Ç–µ—á–µ–∫.

–µ—â–µ –ø—Ä–∏–º–µ—Ä:

```cpp
#include <iostream>
#include <memory>

struct MyClass {
    void say() { std::cout << "I'm alive\n"; }
};

int main() {
    std::shared_ptr<MyClass> sp = std::make_shared<MyClass>();
    std::weak_ptr<MyClass> wp = sp;  // üëà —Å–æ–∑–¥–∞–Ω–∏–µ weak_ptr

    if (auto locked = wp.lock()) {  // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º weak_ptr –æ–±—Ä–∞—Ç–Ω–æ –≤ shared_ptr
        locked->say();
    } else {
        std::cout << "Object already destroyed\n";
    }

    sp.reset();  // —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –æ–±—ä–µ–∫—Ç

    if (auto locked = wp.lock()) {
        locked->say();
    } else {
        std::cout << "Object already destroyed\n";  // ‚Üê —Å—é–¥–∞ –ø–æ–ø–∞–¥—ë–º
    }
}

```


---
#### `auto_ptr` (—É—Å—Ç–∞—Ä–µ–ª!)

#### –ß—Ç–æ —ç—Ç–æ?

- –£–º–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å –∏–∑ C++98/C++03 –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –≤–ª–∞–¥–µ–Ω–∏—è.
    
- –ò–º–µ–ª —Å–µ–º–∞–Ω—Ç–∏–∫—É **–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** (—á—É—Ç—å –ª–∏ –Ω–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–æ C++11).
    
- –í–≤–µ–ª –º–Ω–æ–≥–æ –ø—Ä–æ–±–ª–µ–º —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å—é.
    
- –£—Å—Ç–∞—Ä–µ–ª, **–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å!**
    
---
#### –ü–æ—á–µ–º—É —É—Å—Ç–∞—Ä–µ–ª?

- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `auto_ptr` **–∑–∞–±–∏—Ä–∞–ª–æ –≤–ª–∞–¥–µ–Ω–∏–µ —É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞** ‚Äî –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.
    
- –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–∞—Å—Å–∏–≤–æ–≤.
    
- –ó–∞–º–µ–Ω—ë–Ω –Ω–∞ `unique_ptr` –≤ C++11.
    
---
#### –°–æ–≤–µ—Ç

> –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π `auto_ptr`. –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—à—å —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º C++ ‚Äî –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `unique_ptr` –∏–ª–∏ `shared_ptr`.

---

# –ò—Ç–æ–≥: –∫–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

|   |   |   |
|---|---|---|
|–¢–∏–ø —É–∫–∞–∑–∞—Ç–µ–ª—è|–ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å|–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏|
|`unique_ptr`|–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ, –æ–¥–∏–Ω –≤–ª–∞–¥–µ–ª–µ—Ü|–õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π, –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ|
|`shared_ptr`|–†–∞–∑–¥–µ–ª—è–µ–º–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ, –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤|–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏ —á–µ—Ä–µ–∑ —Å—á—ë—Ç—á–∏–∫|
|`weak_ptr`|–ù–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –æ–±—ä–µ–∫—Ç–æ–º, –±–µ–∑ –≤–ª–∞–¥–µ–Ω–∏—è|–ò–∑–±–µ–≥–∞–Ω–∏–µ —Ü–∏–∫–ª–æ–≤ –≤–ª–∞–¥–µ–Ω–∏—è|
|`auto_ptr`|**–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**|–£—Å—Ç–∞—Ä–µ–ª, –∑–∞–º–µ–Ω—ë–Ω `unique_ptr`|
–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –∏—Å–ø–æ–ª—å–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ `make_unique` –∏–ª–∏ `make_shared` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≤—ã–¥–µ–ª–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏ –¥–ª—è `Class` –∏ _control block_. –í —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä—É–∫—Ü–∏–π `make` –ø–∞–º—è—Ç—å –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —É–º–Ω–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è –≤—ã–¥–µ–ª—è–µ—Ç—Å—è *–µ–¥–∏–Ω–æ–∂–¥—ã*